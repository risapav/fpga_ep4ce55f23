name: Generuj dokument√°ciu

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    paths:
      - "src/**/*.sv"
      - ".github/workflows/gen-docs.yml"
  workflow_dispatch:

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è Checkout k√≥du
        uses: actions/checkout@v4

      - name: üêç Nastav Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ In≈°taluj z√°vislosti a spusti gener√°tor
        run: |
          pip install --upgrade pip
          python scripts/extract_sv_docs.py
          python scripts/generate_index.py

      - name: üîç Debug ‚Äì v√Ωpis vygenerovan√Ωch s√∫borov
        run: |
          echo "Obsah prieƒçinka docs_md/modules:"
          ls -lh docs_md/modules || echo "‚ö†Ô∏è Prieƒçinok neexistuje alebo je pr√°zdny"

      - name: ‚úÖ Commit vygenerovan√Ωch s√∫borov (ak existuj√∫)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Spoƒç√≠taj vstupn√© .sv s√∫bory
          SRC_COUNT=$(find src -type f -name "*.sv" | wc -l)
          echo "üì¶ .sv s√∫borov na spracovanie: $SRC_COUNT"

          # Spoƒç√≠taj vygenerovan√© .md s√∫bory
          if ls docs_md/modules/*.md 1> /dev/null 2>&1; then
            MD_COUNT=$(find docs_md/modules -type f -name "*.md" | wc -l)
            echo "üìù Vygenerovan√Ωch .md s√∫borov: $MD_COUNT"

            # Pridaj a commitni zmeny
            git add docs_md/index.md || true
            find docs_md/modules -name "*.md" -exec git add {} +

            # Spoƒç√≠taj poƒçet zmenen√Ωch s√∫borov (staged)
            CHANGED_COUNT=$(git diff --cached --name-only | wc -l)

            if [ "$CHANGED_COUNT" -gt 0 ]; then
              git commit -m "üìù Auto-generovan√° dokument√°cia z .sv s√∫borov"
              git push
              echo "‚úÖ Zmeny commitnut√©: $CHANGED_COUNT s√∫borov"
            else
              echo "‚ö†Ô∏è ≈Ωiadne zmeny na commit."
            fi
          else
            echo "‚ö†Ô∏è Neboli n√°jden√© ≈æiadne .md s√∫bory na pridanie."
            MD_COUNT=0
          fi

          echo "üìä Prehƒæad:"
          echo " - .sv s√∫borov prehliadnut√Ωch : $SRC_COUNT"
          echo " - .md s√∫borov vygenerovan√Ωch : $MD_COUNT"
          echo " - .md s√∫borov commitnut√Ωch   : $CHANGED_COUNT"


